// Code generated by smithy-go-codegen DO NOT EDIT.

package quicksight

import (
	"context"
	"fmt"
	awsmiddleware "github.com/aws/aws-sdk-go-v2/aws/middleware"
	"github.com/aws/aws-sdk-go-v2/service/quicksight/types"
	"github.com/aws/smithy-go/middleware"
	smithyhttp "github.com/aws/smithy-go/transport/http"
	"time"
)

// Retrieves the identity context for a Quick Sight user in a specified namespace,
// allowing you to obtain identity tokens that can be used with identity-enhanced
// IAM role sessions to call identity-aware APIs.
//
// # Currently, you can call the following APIs with identity-enhanced Credentials
//
// [StartDashboardSnapshotJob]
//
// [DescribeDashboardSnapshotJob]
//
// [DescribeDashboardSnapshotJobResult]
//
// # Supported Authentication Methods
//
// This API supports Quick Sight native users, IAM federated users, and Active
// Directory users. For Quick Sight users authenticated by Amazon Web Services
// Identity Center, see [Identity Center documentation on identity-enhanced IAM role sessions].
//
// # Getting Identity-Enhanced Credentials
//
// To obtain identity-enhanced credentials, follow these steps:
//
//   - Call the GetIdentityContext API to retrieve an identity token for the
//     specified user.
//
//   - Use the identity token with the [STS AssumeRole API]to obtain identity-enhanced IAM role
//     session credentials.
//
// # Usage with STS AssumeRole
//
// The identity token returned by this API should be used with the STS AssumeRole
// API to obtain credentials for an identity-enhanced IAM role session. When
// calling AssumeRole, include the identity token in the ProvidedContexts
// parameter with ProviderArn set to arn:aws:iam::aws:contextProvider/QuickSight
// and ContextAssertion set to the identity token received from this API.
//
// The assumed role must allow the sts:SetContext action in addition to
// sts:AssumeRole in its trust relationship policy. The trust policy should include
// both actions for the principal that will be assuming the role.
//
// [DescribeDashboardSnapshotJobResult]: https://docs.aws.amazon.com/quicksight/latest/APIReference/API_DescribeDashboardSnapshotJobResult.html
// [Identity Center documentation on identity-enhanced IAM role sessions]: https://docs.aws.amazon.com/singlesignon/latest/userguide/trustedidentitypropagation-identity-enhanced-iam-role-sessions.html
// [DescribeDashboardSnapshotJob]: https://docs.aws.amazon.com/quicksight/latest/APIReference/API_DescribeDashboardSnapshotJob.html
// [STS AssumeRole API]: https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html
// [StartDashboardSnapshotJob]: https://docs.aws.amazon.com/quicksight/latest/APIReference/API_StartDashboardSnapshotJob.html
func (c *Client) GetIdentityContext(ctx context.Context, params *GetIdentityContextInput, optFns ...func(*Options)) (*GetIdentityContextOutput, error) {
	if params == nil {
		params = &GetIdentityContextInput{}
	}

	result, metadata, err := c.invokeOperation(ctx, "GetIdentityContext", params, optFns, c.addOperationGetIdentityContextMiddlewares)
	if err != nil {
		return nil, err
	}

	out := result.(*GetIdentityContextOutput)
	out.ResultMetadata = metadata
	return out, nil
}

// ///////////////////////// /////////////////////////
type GetIdentityContextInput struct {

	// The ID for the Amazon Web Services account that the user whose identity context
	// you want to retrieve is in. Currently, you use the ID for the Amazon Web
	// Services account that contains your Quick Sight account.
	//
	// This member is required.
	AwsAccountId *string

	// The identifier for the user whose identity context you want to retrieve.
	//
	// This member is required.
	UserIdentifier types.UserIdentifier

	// The namespace of the user that you want to get identity context for. This
	// parameter is required when the UserIdentifier is specified using Email or
	// UserName.
	Namespace *string

	// The timestamp at which the session will expire.
	SessionExpiresAt *time.Time

	noSmithyDocumentSerde
}

type GetIdentityContextOutput struct {

	// The Amazon Web Services request ID for this operation.
	//
	// This member is required.
	RequestId *string

	// The HTTP status of the request.
	//
	// This member is required.
	Status *int32

	// The identity context information for the user. This is an identity token that
	// should be used as the ContextAssertion parameter in the [STS AssumeRole API]call to obtain identity
	// enhanced AWS credentials.
	//
	// [STS AssumeRole API]: https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html
	Context *string

	// Metadata pertaining to the operation's result.
	ResultMetadata middleware.Metadata

	noSmithyDocumentSerde
}

func (c *Client) addOperationGetIdentityContextMiddlewares(stack *middleware.Stack, options Options) (err error) {
	if err := stack.Serialize.Add(&setOperationInputMiddleware{}, middleware.After); err != nil {
		return err
	}
	err = stack.Serialize.Add(&awsRestjson1_serializeOpGetIdentityContext{}, middleware.After)
	if err != nil {
		return err
	}
	err = stack.Deserialize.Add(&awsRestjson1_deserializeOpGetIdentityContext{}, middleware.After)
	if err != nil {
		return err
	}
	if err := addProtocolFinalizerMiddlewares(stack, options, "GetIdentityContext"); err != nil {
		return fmt.Errorf("add protocol finalizers: %v", err)
	}

	if err = addlegacyEndpointContextSetter(stack, options); err != nil {
		return err
	}
	if err = addSetLoggerMiddleware(stack, options); err != nil {
		return err
	}
	if err = addClientRequestID(stack); err != nil {
		return err
	}
	if err = addComputeContentLength(stack); err != nil {
		return err
	}
	if err = addResolveEndpointMiddleware(stack, options); err != nil {
		return err
	}
	if err = addComputePayloadSHA256(stack); err != nil {
		return err
	}
	if err = addRetry(stack, options); err != nil {
		return err
	}
	if err = addRawResponseToMetadata(stack); err != nil {
		return err
	}
	if err = addRecordResponseTiming(stack); err != nil {
		return err
	}
	if err = addSpanRetryLoop(stack, options); err != nil {
		return err
	}
	if err = addClientUserAgent(stack, options); err != nil {
		return err
	}
	if err = smithyhttp.AddErrorCloseResponseBodyMiddleware(stack); err != nil {
		return err
	}
	if err = smithyhttp.AddCloseResponseBodyMiddleware(stack); err != nil {
		return err
	}
	if err = addSetLegacyContextSigningOptionsMiddleware(stack); err != nil {
		return err
	}
	if err = addTimeOffsetBuild(stack, c); err != nil {
		return err
	}
	if err = addUserAgentRetryMode(stack, options); err != nil {
		return err
	}
	if err = addCredentialSource(stack, options); err != nil {
		return err
	}
	if err = addOpGetIdentityContextValidationMiddleware(stack); err != nil {
		return err
	}
	if err = stack.Initialize.Add(newServiceMetadataMiddleware_opGetIdentityContext(options.Region), middleware.Before); err != nil {
		return err
	}
	if err = addRecursionDetection(stack); err != nil {
		return err
	}
	if err = addRequestIDRetrieverMiddleware(stack); err != nil {
		return err
	}
	if err = addResponseErrorMiddleware(stack); err != nil {
		return err
	}
	if err = addRequestResponseLogging(stack, options); err != nil {
		return err
	}
	if err = addDisableHTTPSMiddleware(stack, options); err != nil {
		return err
	}
	if err = addInterceptBeforeRetryLoop(stack, options); err != nil {
		return err
	}
	if err = addInterceptAttempt(stack, options); err != nil {
		return err
	}
	if err = addInterceptors(stack, options); err != nil {
		return err
	}
	return nil
}

func newServiceMetadataMiddleware_opGetIdentityContext(region string) *awsmiddleware.RegisterServiceMetadata {
	return &awsmiddleware.RegisterServiceMetadata{
		Region:        region,
		ServiceID:     ServiceID,
		OperationName: "GetIdentityContext",
	}
}

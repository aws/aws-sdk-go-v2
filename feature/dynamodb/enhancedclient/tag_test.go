package enhancedclient

import (
	"fmt"
	"reflect"
	"testing"
)

func TestTagParse(t *testing.T) {
	cases := []struct {
		in       reflect.StructTag
		json, av bool
		expect   Tag
	}{
		{`json:""`, true, false, Tag{}},
		{`json:"name"`, true, false, Tag{Name: "name"}},
		{`json:"name,omitempty"`, true, false, Tag{Name: "name", OmitEmpty: true}},
		{`json:"-"`, true, false, Tag{Ignore: true}},
		{`json:",omitempty"`, true, false, Tag{OmitEmpty: true}},
		{`json:",string"`, true, false, Tag{AsString: true}},
		{`dynamodbav:""`, false, true, Tag{}},
		{`dynamodbav:","`, false, true, Tag{}},
		{`dynamodbav:"name"`, false, true, Tag{Name: "name"}},
		{`dynamodbav:"name"`, false, true, Tag{Name: "name"}},
		{`dynamodbav:"-"`, false, true, Tag{Ignore: true}},
		{`dynamodbav:",omitempty"`, false, true, Tag{OmitEmpty: true}},
		{`dynamodbav:",omitemptyelem"`, false, true, Tag{OmitEmptyElem: true}},
		{`dynamodbav:",string"`, false, true, Tag{AsString: true}},
		{`dynamodbav:",binaryset"`, false, true, Tag{AsBinSet: true}},
		{`dynamodbav:",numberset"`, false, true, Tag{AsNumSet: true}},
		{`dynamodbav:",stringset"`, false, true, Tag{AsStrSet: true}},
		{`dynamodbav:",stringset,omitemptyelem"`, false, true, Tag{AsStrSet: true, OmitEmptyElem: true}},
		{`dynamodbav:"name,stringset,omitemptyelem"`, false, true, Tag{Name: "name", AsStrSet: true, OmitEmptyElem: true}},
		{`dynamodbav:",version"`, false, true, Tag{Version: true}},
		{`dynamodbav:",preserveempty"`, false, true, Tag{PreserveEmpty: true}},
		{`dynamodbav:",json"`, false, true, Tag{JSON: true}},
		{`dynamodbav:",autogenerated|key"`, false, true, Tag{AutoGenerated: true, Options: map[string][]string{"autogenerated": {"key"}}}},
		{`dynamodbav:",autogenerated|timestamp"`, false, true, Tag{AutoGenerated: true, Options: map[string][]string{"autogenerated": {"timestamp"}}}},
		{`dynamodbav:",atomiccounter"`, false, true, Tag{AtomicCounter: true}},
		{`dynamodbav:",atomiccounter|start=0"`, false, true, Tag{AtomicCounter: true, Options: map[string][]string{"atomiccounter": {"start=0"}}}},
		{`dynamodbav:",atomiccounter|delta=1"`, false, true, Tag{AtomicCounter: true, Options: map[string][]string{"atomiccounter": {"delta=1"}}}},
		{`dynamodbav:",atomiccounter|delta=-1"`, false, true, Tag{AtomicCounter: true, Options: map[string][]string{"atomiccounter": {"delta=-1"}}}},
		{`dynamodbav:",atomiccounter|start=0|delta=-1"`, false, true, Tag{AtomicCounter: true, Options: map[string][]string{"atomiccounter": {"start=0", "delta=-1"}}}},
		{`dynamodbav:",enumasstring"`, false, true, Tag{EnumAsString: true}},
		{`dynamodbav:",partition"`, false, true, Tag{Partition: true}},
		{`dynamodbav:",sort"`, false, true, Tag{Sort: true}},
		{`dynamodbgetter:"Prop" dynamodbsetter:"SetProp"`, false, true, Tag{Getter: "", Setter: ""}},
		{`dynamodbav:"prop" dynamodbgetter:"Prop" dynamodbsetter:"SetProp"`, false, true, Tag{Name: "prop", Getter: "Prop", Setter: "SetProp"}},
		{`dynamodbav:"prop" dynamodbindex:"idx"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx"}}}},
		{`dynamodbav:"prop" dynamodbindex:"idx,local"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx", Local: true}}}},
		{`dynamodbav:"prop" dynamodbindex:"idx,global"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx", Global: true}}}},
		{`dynamodbav:"prop" dynamodbindex:"idx,partition"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx", Partition: true}}}},
		{`dynamodbav:"prop" dynamodbindex:"idx,sort"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx", Sort: true}}}},
		{`dynamodbav:"prop" dynamodbindex:"idx,global,local,partition,sort"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx", Global: true, Local: true, Partition: true, Sort: true}}}},
		{`dynamodbav:"prop" dynamodbindex:",global,local,partition,sort"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "", Global: true, Local: true, Partition: true, Sort: true}}}},
		{`dynamodbav:"prop" dynamodbindex:","`, false, true, Tag{Name: "prop", Indexes: []Index{{}}}},
		{`dynamodbav:"prop" dynamodbindex:""`, false, true, Tag{Name: "prop"}},
		// unsupported tags are ignored
		{`dynamodbav:"prop" dynamodbindex:"idx,unsupportedtag"`, false, true, Tag{Name: "prop", Indexes: []Index{{Name: "idx"}}}},
		{`dynamodbav:",unsupportedtag"`, false, true, Tag{}},
		//{`dynamodbav:",flatten"`, false, true, Tag{Flatten: true}},
	}

	for i, c := range cases {
		t.Run(fmt.Sprintf("%d", i), func(t *testing.T) {
			actual := Tag{}
			if c.json {
				actual.parseStructTag("json", c.in)
			}
			if c.av {
				actual.parseAVTag(c.in)
			}
			if e, a := c.expect, actual; !reflect.DeepEqual(e, a) {
				t.Errorf("case %d [%s], expect %v, got %v", i, c.in, e, a)
			}
		})
	}
}
